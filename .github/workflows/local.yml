name: Local CI (act-friendly)

on:
  workflow_dispatch:

# This workflow is designed to work with act (GitHub Actions emulator) for local testing.
# It uses system compilers and avoids heavy Docker images to be fast and lightweight.
#
# Usage:
#   act -j local-gcc        # Run GCC job only
#   act -j local-clang      # Run Clang job only
#   act                     # Run all jobs
#
# Requirements for Arch Linux (or similar):
#   - Base packages: cmake ninja gcc clang libc++
#   - For coverage: lcov
#   - All compilers should be installed system-wide

jobs:
  local-gcc:
    name: Local GCC
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            ${{ env.CATCH2_SOURCE != '' && format('-DCATCH2_SOURCE={0}', env.CATCH2_SOURCE) || '' }} \
            -G Ninja

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build/tests
        run: ctest --output-on-failure

  local-clang-libstdcxx:
    name: Local Clang (libstdc++)
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            ${{ env.CATCH2_SOURCE != '' && format('-DCATCH2_SOURCE={0}', env.CATCH2_SOURCE) || '' }} \
            -G Ninja

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build/tests
        run: ctest --output-on-failure

  local-clang-libcxx:
    name: Local Clang (libc++)
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            -DCMAKE_CXX_FLAGS=-stdlib=libc++ \
            ${{ env.CATCH2_SOURCE != '' && format('-DCATCH2_SOURCE={0}', env.CATCH2_SOURCE) || '' }} \
            -G Ninja

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build/tests
        run: ctest --output-on-failure
        
  local-clang-libcxx-asan-ubsan:
    name: Clang (libc++, asan, ubsan)
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            -DCMAKE_CXX_FLAGS="-stdlib=libc++ -fsanitize=address,undefined -fno-omit-frame-pointer -fno-optimize-sibling-calls -D_LIBCPP_ENABLE_ASSERTIONS=1 -D_LIBCPP_HARDENING_MODE=_LIBCPP_HARDENING_MODE_DEBUG" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            ${{ env.CATCH2_SOURCE != '' && format('-DCATCH2_SOURCE={0}', env.CATCH2_SOURCE) || '' }} \
            -G Ninja

      - name: Build
        run: cmake --build build --parallel

      - name: Set stack limit
        run: ulimit -s 1048576

      - name: Run tests
        working-directory: build/tests
        run: ctest --output-on-failure

  local-coverage:
    name: Local Coverage
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake with coverage
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            -DCMAKE_CXX_FLAGS="--coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            ${{ env.CATCH2_SOURCE != '' && format('-DCATCH2_SOURCE={0}', env.CATCH2_SOURCE) || '' }} \
            -G Ninja

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build/tests
        run: ctest --output-on-failure

      - name: Generate coverage report
        working-directory: build
        run: |
          lcov --ignore-errors empty,unused,inconsistent --capture --directory . --output-file coverage.raw.info --rc geninfo_unexecuted_blocks=1 --ignore-errors source
          lcov --ignore-errors empty,unused --remove coverage.raw.info '/usr/*' '*/_deps/*' "*/catch2/*" --output-file coverage.info
          lcov --list coverage.info
          echo "Coverage report generated at build/tests/coverage.info"
          echo "To generate HTML report, run: lcov --generate-html coverage.info"
